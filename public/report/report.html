<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles.css">
    <title>Relatar Estado do ATM</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body>
    <h1>Relatar Estado do ATM</h1>
    
    <button id="voltarBtn" onclick="window.location.href='../index.html';">Voltar</button>

    <form id="reportForm">
        <label for="selectATM">Selecione um ATM:</label>
        <select id="selectATM" required>
            <option value="">Selecione um ATM</option>
        </select>
        <label for="servico">Status do Serviço:</label>
        <select id="servico" required>
            <option value="Em Serviço">Em Serviço</option>
            <option value="Fora de Serviço">Fora de Serviço</option>
        </select>
        <label for="dinheiro">Dinheiro Disponível:</label>
        <select id="dinheiro" required>
            <option value="Com Dinheiro">Com Dinheiro</option>
            <option value="Sem Dinheiro">Sem Dinheiro</option>
        </select>
        <label for="volumePessoas">Volume de Pessoas:</label>
        <select id="volumePessoas" required>
            <option value="Baixo">Baixo</option>
            <option value="Moderado">Moderado</option>
            <option value="Alto">Alto</option>
        </select>
        <button type="submit">Enviar Relato</button>
    </form>

    <div id="timer" style="display:none;">Você pode relatar novamente em: <span id="timeRemaining"></span></div>

    <footer>
        <a href="https://www.facebook.com/profile.php?id=61566547542597" target="_blank">Siga-nos no Facebook</a>
    </footer>

    <!-- Anúncio AdSense -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
         data-ad-slot="XXXXXXXXXX"
         data-ad-format="auto"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcVkEALq5uJH8yIpvIlnNLHBjPLUUzb_s",
            authDomain: "numbutatoa.firebaseapp.com",
            projectId: "numbutatoa",
            storageBucket: "numbutatoa.appspot.com",
            messagingSenderId: "659873259259",
            appId: "1:659873259259:web:eba1ce3a5c6c9ed79a9a5e",
            measurementId: "G-CRB1ML2JDB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Função para gerar um ID único (simulação do ID do telefone)
        function getPhoneId() {
            let phoneId = localStorage.getItem("phoneId");
            if (!phoneId) {
                phoneId = `phone_${new Date().getTime()}_${Math.random()}`;
                localStorage.setItem("phoneId", phoneId);
            }
            return phoneId;
        }

        const phoneId = getPhoneId();
        let lastReportTime = localStorage.getItem("lastReportTime") || 0;
        let reportCooldown = 5 * 60 * 1000; // 5 minutos em milissegundos
        let points = parseInt(localStorage.getItem("points")) || 0; // Carregar os pontos do usuário

        // Carregar ATMs na lista
        async function carregarATMs() {
            const atmSelect = document.getElementById("selectATM");
            const querySnapshot = await getDocs(collection(db, "ATMs"));

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const option = document.createElement("option");
                option.value = doc.id;
                option.textContent = `${data.nomeBanco}, ${data.rua}, ${data.bairro}`;
                atmSelect.appendChild(option);
            });
        }

        // Calcular a distância entre duas coordenadas
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Raio da Terra em metros
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distância em metros
        }

        // Relatar o estado do ATM
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("reportForm").addEventListener("submit", async (event) => {
                event.preventDefault();

                const currentTime = Date.now();
                const timeSinceLastReport = currentTime - lastReportTime;

                // Verifica se o usuário pode relatar
                if (timeSinceLastReport < reportCooldown) {
                    alert(`Você precisa esperar ${((reportCooldown - timeSinceLastReport) / 1000).toFixed(0)} segundos antes de relatar novamente.`);
                    return;
                }

                const atmId = document.getElementById("selectATM").value;
                const servico = document.getElementById("servico").value;
                const dinheiro = document.getElementById("dinheiro").value;
                const volumePessoas = document.getElementById("volumePessoas").value;

                await relatarEstadoATM(atmId, servico, dinheiro, volumePessoas);
                event.target.reset(); // Reseta o formulário

                // Exibir o anúncio após o sucesso
                showAd();
            });

            // Carregar os ATMs quando a página for carregada
            carregarATMs();
        });

        // Função para relatar o estado do ATM
        async function relatarEstadoATM(atmId, servico, dinheiro, volumePessoas) {
            const atmRef = doc(db, "ATMs", atmId);
            const atmData = await getDoc(atmRef);

            if (!atmData.exists()) {
                alert("ATM não encontrado!");
                return;
            }

            const { latitude, longitude } = atmData.data();

            navigator.geolocation.getCurrentPosition(async (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;

                const distancia = calcularDistancia(userLat, userLon, latitude, longitude);

                // Verifica se a distância é menor que 500 metros
                if (distancia <= 500) {
                    await updateDoc(atmRef, {
                        infoAdicional: `Status do Serviço: ${servico}, Dinheiro: ${dinheiro}, Volume de Pessoas: ${volumePessoas}`,
                    });
                    alert("Estado do ATM relatado com sucesso!");

                    // Adicionar pontos ao usuário (2 pontos)
                    points += 2; // Adicione 2 pontos
                    localStorage.setItem("points", points);
                    alert(`Você ganhou 2 pontos! Total de pontos: ${points}`);

                    lastReportTime = Date.now();
                    localStorage.setItem("lastReportTime", lastReportTime);
                    updateTimerDisplay();
                } else {
                    alert("Você precisa estar a 500 metros do ATM para relatar o estado.");
                }
            });
        }

        // Atualiza o display do temporizador
        function updateTimerDisplay() {
            const timeRemaining = Math.max(0, reportCooldown - (Date.now() - lastReportTime));
            const seconds = Math.floor((timeRemaining / 1000) % 60);
            const minutes = Math.floor((timeRemaining / 1000 / 60) % 60);

            document.getElementById("timeRemaining").textContent = `${minutes} minutos e ${seconds} segundos`;

            if (timeRemaining > 0) {
                document.getElementById("timer").style.display = "block";
                setTimeout(updateTimerDisplay, 1000);
            } else {
                document.getElementById("timer").style.display = "none";
            }
        }
    </script>
</body>
</html>
